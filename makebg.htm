<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <style>
        #bg {
            display: none;
        }
    </style>
</head>

<body>

    <label>图片长(像素)<input type="text" id="img_w" value="770" /></label><br />
    <label>图片高(像素)<input type="text" id="img_h" value="770" /></label><br />
    <label>距左侧(像素)<input type="text" id="img_x" value="115" /></label><br />
    <label>距上侧(像素)<input type="text" id="img_y" value="115" /></label><br />
    <label>变暗(0.2=加20%黑色)<input type="text" id="img_dark" value="0.2" /></label><br />
    <label>选择图片上传：
        <input type="file" accept="image/*" id="imgup">
    </label><br />
    <input type="button" onclick="run()" value="图片合成"><br />
    合成完，右键->保存[底部的图片]<br />
    可以直接去 <a href="http://sm.ms">http://sm.ms</a> 也可以利用下方的小工具
    <hr />
    <h3>往SM.MS传图片的简单程序↓</h3>
    <h3>请传带边框的图↓</h3>
    <label>请选择带边框的图：
        <input type="file" name="smfile" id="smfile">
    </label><br />
    <input type="button" onclick="imgup()" value="上传到SM.MS" /><br />
    <label>上传后图片URL：<input type="text" id="img_url" value="请先【合成图片】" /></label><br />
    这个URL填到【重定向至：xxxx】
    <hr />
    <canvas id="myCanvas" width="1000" height="1000" style="border:1px solid #d3d3d3;">
        Your browser does not support the HTML5 canvas tag.
    </canvas>
    <img src="res/border.png" id="bg" />

    <script>
        function imgup() {
            var fileObj = document.getElementById("smfile").files[0]; // js 获取文件对象
            if (typeof (fileObj) == "undefined" || fileObj.size <= 0) {
                alert("请选择图片");
                return;
            }
            var formFile = new FormData();
            formFile.append("smfile", fileObj); //加入文件对象

            $.ajax({
                url: "https://sm.ms/api/upload",
                data: formFile,
                type: "Post",
                dataType: "json",
                cache: false,//上传文件无需缓存
                processData: false,//用于对data参数进行序列化处理 这里必须false
                contentType: false, //必须
                success: function (data) {
                    if (data.code == "success") {
                        alert("上傳成功");
                        document.getElementById("img_url").value = data.data.url;
                    }
                    else { alert('上傳錯誤，請從新上傳'); }
                },
            })
        }

        function run() {
            let file = document.getElementById('imgup').files[0]  // 获取选择的文件，这里是图片类型
            if (typeof (file) == "undefined" || file.size <= 0) {
                alert("请选择图片");
                return;
            }
            let reader = new FileReader()
            reader.readAsDataURL(file) //读取文件并将文件以URL的形式保存在resulr属性中 base64格式
            reader.onload = function (e) { // 文件读取完成时触发 
                let result = e.target.result // base64格式图片地址 
                var image = new Image();
                image.src = result // 设置image的地址为base64的地址 
                image.setAttribute('crossOrigin', 'anonymous');
                image.onload = function () {
                    var Canvas = document.getElementById("myCanvas");
                    var cxt = Canvas.getContext("2d");
                    Canvas.height = 1001;
                    Canvas.height = 1000;
                    var bg = document.getElementById("bg");
                    bg.setAttribute('crossOrigin', 'anonymous');
                    var x = document.getElementById("img_x").value;
                    var y = document.getElementById("img_y").value;
                    var w = document.getElementById("img_w").value;
                    var h = document.getElementById("img_h").value;
                    cxt.drawImage(image, x, y, w, h) // 在canvas上绘制图片 
                    var alpha = document.getElementById("img_dark").value;
                    alpha = Number(alpha).toFixed(2);
                    cxt.fillStyle = 'rgba(0, 0, 0, ' + alpha + ')';
                    cxt.fillRect(0, 0, 1000, 1000);
                    cxt.drawImage(bg, 0, 0, 1000, 1000);
                    window.makeimg = Canvas.toDataURL('image/jpeg');
                    window.maked = 1;
                }
            }
        };

    </script>

</body>

</html>